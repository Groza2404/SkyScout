{% extends 'layout.html' %}

{% block title %}Weather Tracker{% endblock %}

{% block header %}Weather Tracker{% endblock %}

{% block main %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <form id="weatherForm">
            <div class="input-group mb-3">
                <input type="text" class="form-control" id="locationInput" placeholder="Enter city name" aria-label="Enter city name" aria-describedby="button-addon2">
                <button class="btn btn-outline-primary" type="submit" id="searchButton">Search</button>
            </div>
        </form>
    </div>
</div>

<div class="row justify-content-center" id="weatherResults">
    <!-- Weather data will be dynamically populated here -->
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('weatherForm');
    const locationInput = document.getElementById('locationInput');
    const weatherResults = document.getElementById('weatherResults');

    // Fetch weather data for user's current location initially
    fetchWeatherForCurrentLocation();

    form.addEventListener('submit', function(event) {
        event.preventDefault();
        const city = locationInput.value.trim();
        if (city) {
            fetchWeather(city);
        }
    });

    function fetchWeatherForCurrentLocation() {
        if ('geolocation' in navigator) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                fetch(`/weather?lat=${lat}&lon=${lon}`)
                    .then(response => response.json())
                    .then(data => {
                        displayWeather(data);
                    })
                    .catch(error => {
                        console.error('Error fetching weather:', error);
                        displayError('Failed to fetch weather data.');
                    });
            }, function(error) {
                console.error('Error getting user location:', error);
                displayError('Failed to get user location.');
            });
        } else {
            displayError('Geolocation is not supported by this browser.');
        }
    }

    function fetchWeather(city) {
        fetch(`/weather?city=${city}`)
            .then(response => response.json())
            .then(data => {
                displayWeather(data, city);
            })
            .catch(error => {
                console.error('Error fetching weather:', error);
                displayError('Failed to fetch weather data.');
            });
    }

    function displayWeather(data, city = '') {
        console.log('Weather data received:', data);
        weatherResults.innerHTML = ''; // Clear previous results
        if (data.current && data.timezone) {
            const descpr = data.current.weather[0];
            const title = city || data.timezone;
            const weatherCard = `
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">${title}</h5>
                            <p class="card-text">Temperature: ${Math.round(data.current.temp - 273.15)}Â°C</p>
                            <p class="card-text">Weather: ${descpr.description}</p>
                        </div>
                    </div>
                </div>
            `;
            weatherResults.innerHTML = weatherCard;
        } else {
            displayError('Weather data not available.');
        }
    }

    function displayError(message) {
        weatherResults.innerHTML = `<div class="alert alert-danger" role="alert">${message}</div>`;
    }
});
</script>
{% endblock %}